<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ©Ÿèƒ½è¦‹ç©ã‚‚ã‚Šç®¡ç†ãƒ„ãƒ¼ãƒ« v1.3</title>
    <style>
        :root {
            --primary-color: #4f46e5; --secondary-color: #7c3aed; --success-color: #10b981;
            --danger-color: #ef4444; --light-gray: #f9fafb; --dark-gray: #374151;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: #f0f2f5; min-height: 100vh; padding: 20px; color: #333;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px;
            padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        footer { text-align: center; margin-top: 20px; color: #9ca3af; font-size: 12px; }
        h1, h2, h3 { margin-bottom: 20px; color: var(--dark-gray); }
        h1 { text-align: center; font-size: 28px; color: var(--primary-color); }
        h2 { font-size: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark-gray); }
        input, select {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .grid-layout {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .btn-group { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .btn {
            padding: 12px 24px; background-image: linear-gradient(to right, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;
            font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .btn-success { background-image: linear-gradient(to right, #10b981 0%, #34d399 100%); }
        .btn-danger { background-image: linear-gradient(to right, #ef4444 0%, #f87171 100%); }
        .btn-secondary { background-image: linear-gradient(to right, #6b7280 0%, #9ca3af 100%); }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
        th { background: var(--light-gray); font-weight: 600; }
        .amount { text-align: right; font-weight: 600; color: var(--success-color); font-size: 16px; }
        .total-section { background: #fff; border: 1px solid #e5e7eb; color: var(--dark-gray); padding: 20px; border-radius: 10px; margin-top: 20px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .total-final { border-top: 2px solid var(--primary-color); padding-top: 10px; font-size: 22px; font-weight: 700; color: var(--primary-color);}
        .delete-btn, .edit-btn { color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .delete-btn { background: var(--danger-color); }
        .edit-btn { background: var(--primary-color); }
        .category-inputs { display: flex; flex-direction: column; gap: 5px; }
        .category-inputs input { padding: 8px; }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 800px; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        /* Tree View */
        .tree-view { border: 1px solid #ccc; padding: 10px; height: 300px; overflow: auto; }
        .tree-view ul { list-style-type: none; padding-left: 20px; }
        .tree-view li { padding: 5px; cursor: pointer; border-radius: 4px; }
        .tree-view li.selected { background-color: var(--primary-color); color: white; }
        .tree-view .folder::before { content: 'ğŸ“ '; }
        .tree-view .file::before { content: 'ğŸ“„ '; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš› é«˜æ©Ÿèƒ½è¦‹ç©ã‚‚ã‚Šç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
        <div class="company-section"><h2>ğŸ¢ ä¼šç¤¾è¨­å®š</h2><div class="grid-layout"><div class="form-group"><label>ä¼šç¤¾é¸æŠ</label><select id="companySelect" onchange="switchCompany()"></select></div><div class="form-group"><label>åŠ´å‹™å˜ä¾¡ï¼ˆå††/æ™‚é–“ï¼‰</label><input type="number" id="laborRate" onchange="updateCompanyLaborRate()"></div><div class="form-group" style="align-self: flex-end;"><button class="btn" onclick="addCompany()">ä¼šç¤¾è¿½åŠ </button><button class="btn-danger" onclick="deleteCompany()">è¨­å®šå‰Šé™¤</button></div></div></div>
        <h2>ğŸ“ è¦‹ç©ã‚‚ã‚Šæƒ…å ±</h2><div class="grid-layout"><div class="form-group"><label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label><input type="text" id="projectName"></div><div class="form-group"><label>ãŠå®¢æ§˜å</label><input type="text" id="customerName" placeholder="æ ªå¼ä¼šç¤¾â—‹â—‹"></div><div class="form-group"><label>è»Šä¸¡æƒ…å ±</label><input type="text" id="vehicleInfo" placeholder="ã„ã™ã‚ ã‚¨ãƒ«ãƒ•"></div></div>
        <div class="btn-group">
            <button class="btn" onclick="addWork()">ğŸ”§ ä½œæ¥­è¿½åŠ </button>
            <button class="btn btn-success" onclick="addMaterial()">ğŸ“¦ è³‡æè¿½åŠ </button>
            <button class="btn btn-secondary" onclick="openSaveLoadManager()">ğŸ’¾ ä¿å­˜/èª­è¾¼</button>
            <button class="btn btn-secondary" onclick="openMasterEditor()">âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼ç·¨é›†</button>
            <button class="btn-secondary" onclick="printEstimate()">ğŸ–¨ï¸ å°åˆ·</button>
            <button class="btn btn-success" onclick="exportCSV()">ğŸ“Š CSVå‡ºåŠ›</button>
            <!-- Data Migration Buttons -->
            <button class="btn" onclick="exportAllData()">â†“ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button class="btn" onclick="document.getElementById('importFile').click()">â†‘ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <input type="file" id="importFile" style="display:none;" accept=".json" onchange="importAllData(event)">
        </div>
        <table><thead><tr><th>ç¨®åˆ¥</th><th style="width:35%">åˆ†é¡ (å¤§ãƒ»ä¸­ãƒ»å°)</th><th>æ•°é‡</th><th>å˜ä¾¡/ä¿‚æ•°</th><th>é‡‘é¡</th><th>ãƒ¡ãƒ¢</th><th>å‰Šé™¤</th></tr></thead><tbody id="itemsTable"></tbody></table>
        <div class="total-section"><h3>ğŸ’° è¦‹ç©ã‚‚ã‚Šåˆè¨ˆ</h3><div class="total-row"><span>ä½œæ¥­è²»:</span><span id="workTotal">Â¥0</span></div><div class="total-row"><span>è³‡æè²»:</span><span id="materialTotal">Â¥0</span></div><div class="total-row total-final"><span>åˆè¨ˆé‡‘é¡:</span><span id="grandTotal">Â¥0</span></div></div>
    </div>
    <footer><p id="copyright"></p></footer>
    <div id="masterEditorModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeMasterEditor()">&times;</span><h2>ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç·¨é›†</h2><div style="display:grid; grid-template-columns:1fr; gap:20px;"><div><h3>ä½œæ¥­ãƒã‚¹ã‚¿ãƒ¼</h3><table><thead><tr><th>å¤§åˆ†é¡</th><th>ä¸­åˆ†é¡</th><th>å°åˆ†é¡</th><th>ä¿‚æ•°</th><th>æ“ä½œ</th></tr></thead><tbody id="workMasterList"></tbody></table></div><div><h3>è³‡æãƒã‚¹ã‚¿ãƒ¼</h3><table><thead><tr><th>å¤§åˆ†é¡</th><th>ä¸­åˆ†é¡</th><th>å°åˆ†é¡</th><th>å˜ä¾¡</th><th>æ“ä½œ</th></tr></thead><tbody id="materialMasterList"></tbody></table></div></div></div></div>
    <div id="saveLoadModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeSaveLoadManager()">&times;</span><h2>ğŸ’¾ ä¿å­˜ / èª­è¾¼ç®¡ç†</h2><div class="tree-view" id="estimateTreeView"></div><div class="btn-group" style="margin-top: 20px;"><button class="btn" onclick="saveNewEstimate()">ã“ã“ã«æ–°è¦ä¿å­˜</button><button class="btn" onclick="overwriteEstimate()">é¸æŠé …ç›®ã‚’ä¸Šæ›¸ã</button><button class="btn btn-success" onclick="loadEstimate()">é¸æŠé …ç›®ã‚’èª­è¾¼</button><button class="btn btn-secondary" onclick="createFolder()">ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</button><button class="btn btn-secondary" onclick="renameNode()">åç§°å¤‰æ›´</button><button class="btn btn-danger" onclick="deleteNode()">å‰Šé™¤</button></div></div></div>

    <script>
        // === Global Variables ===
        let items = [], companies = [], workMaster = [], materialMaster = [], estimateTree = [];
        let currentCompanyId = 1, selectedNodeId = 1;

        // === Initialization ===
        document.addEventListener('DOMContentLoaded', () => { loadAllData(); renderUI(); });
        function renderUI() { updateCompanySelect(); switchCompany(); updateTable(); }
        
        // === Data Management (LocalStorage) ===
        function saveAllData() {
            const data = { companies, currentCompanyId, workMaster, materialMaster, estimateTree };
            localStorage.setItem('truckEstimateToolV5', JSON.stringify(data));
        }
        function loadAllData() {
            try {
                const data = JSON.parse(localStorage.getItem('truckEstimateToolV5'));
                if (!data) throw new Error("No data");
                companies = data.companies || getDefaultCompanies();
                currentCompanyId = data.currentCompanyId || 1;
                workMaster = data.workMaster || getDefaultWorkMaster();
                materialMaster = data.materialMaster || getDefaultMaterialMaster();
                estimateTree = data.estimateTree || getDefaultTree();
            } catch (e) {
                companies = getDefaultCompanies();
                workMaster = getDefaultWorkMaster();
                materialMaster = getDefaultMaterialMaster();
                estimateTree = getDefaultTree();
            }
        }
        function getDefaultCompanies() { return [{ id: 1, name: 'æ¨™æº–è¨­å®š', laborRate: 0 }]; }
        function getDefaultWorkMaster() { return [{id:1, large:"æ¿é‡‘", medium:"ã‚ãŠã‚Š", small:"å‡¹ã¿ä¿®ç†", coefficient:1.5}, {id:2, large:"å¡—è£…", medium:"ã‚­ãƒ£ãƒ“ãƒ³", small:"å…¨å¡—è£…", coefficient:8.0}]; }
        function getDefaultMaterialMaster() { return [{id:1, large:"ãƒœãƒ«ãƒˆé¡", medium:"ã‚¹ãƒ†ãƒ³ãƒ¬ã‚¹", small:"M8x20mm", price:50}, {id:2, large:"é‰„æ¿", medium:"SS400", small:"3.2mm 1ã¡", price:4500}]; }
        function getDefaultTree() { return [{ id: 1, name: 'ãƒ«ãƒ¼ãƒˆ', type: 'folder', children: []}]; }

        // === Company Management ===
        function addCompany() { const name = prompt('ä¼šç¤¾å:'); if (!name) return; const laborRate = parseFloat(prompt('åŠ´å‹™å˜ä¾¡:', '3500')); if (isNaN(laborRate)) return; const newId = (companies.length > 0 ? Math.max(...companies.map(c => c.id)) : 0) + 1; companies.push({ id: newId, name, laborRate }); currentCompanyId = newId; saveAllData(); renderUI(); }
        function deleteCompany() { if (companies.length <= 1) return alert('æœ€å¾Œã®ä¼šç¤¾ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚'); const company = companies.find(c => c.id === currentCompanyId); if (confirm(`ã€Œ${company.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { companies = companies.filter(c => c.id !== currentCompanyId); currentCompanyId = companies[0]?.id || 1; saveAllData(); renderUI(); } }
        function updateCompanyLaborRate() { const company = companies.find(c => c.id === currentCompanyId); if (company) { company.laborRate = parseFloat(document.getElementById('laborRate').value) || 0; saveAllData(); updateTable(); } }
        function switchCompany() { currentCompanyId = parseInt(document.getElementById('companySelect').value); const company = companies.find(c => c.id === currentCompanyId); if (company) document.getElementById('laborRate').value = company.laborRate; updateTable(); }
        function updateCompanySelect() { const select = document.getElementById('companySelect'); select.innerHTML = companies.map(c => `<option value="${c.id}" ${c.id == currentCompanyId ? 'selected':''}>${c.name}</option>`).join(''); }

        // === Estimate Item Management ===
        function addWork() { items.push({ id: Date.now(), type: 'work', large: '', medium: '', small: '', quantity: 1, memo: '' }); updateTable(); }
        function addMaterial() { items.push({ id: Date.now(), type: 'material', large: '', medium: '', small: '', quantity: 1, memo: '' }); updateTable(); }
        function deleteItem(id) { items = items.filter(item => item.id !== id); updateTable(); }
        
        // === 3-Tier Classification Logic ===
        function updateItem(id, field, value) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            item[field] = value;
            if (field === 'large') { item.medium = ''; item.small = ''; }
            if (field === 'medium') { item.small = ''; }
            updateTable();
        }
        async function handleItemBlur(id) {
            const item = items.find(i => i.id === id);
            if (!item || !item.large || !item.medium || !item.small) return;
            const masterList = item.type === 'work' ? workMaster : materialMaster;
            const exists = masterList.some(m => m.large === item.large && m.medium === item.medium && m.small === item.small);
            if (!exists) {
                if (confirm(`ã€Œ${item.large} > ${item.medium} > ${item.small}ã€ã‚’ãƒã‚¹ã‚¿ãƒ¼ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    const rateKey = item.type === 'work' ? 'coefficient' : 'price';
                    const ratePrompt = item.type === 'work' ? 'ä¿‚æ•°' : 'å˜ä¾¡';
                    const rate = parseFloat(prompt(`æ–°ã—ã„é …ç›®ã®${ratePrompt}ã‚’å…¥åŠ›:`, item.type === 'work' ? 1.0 : 1000));
                    if (!isNaN(rate)) {
                        masterList.push({ id: Date.now(), large: item.large, medium: item.medium, small: item.small, [rateKey]: rate });
                        saveAllData();
                        updateTable();
                    }
                }
            }
        }
        
        function updateTable() {
            const tbody = document.getElementById('itemsTable');
            tbody.innerHTML = items.map(item => {
                const masterList = item.type === 'work' ? workMaster : materialMaster;
                const largeCats = [...new Set(masterList.map(m => m.large))];
                const mediumCats = item.large ? [...new Set(masterList.filter(m => m.large === item.large).map(m => m.medium))] : [];
                const smallCats = item.large && item.medium ? [...new Set(masterList.filter(m => m.large === item.large && m.medium === item.medium).map(m => m.small))] : [];
                const masterItem = masterList.find(m => m.large === item.large && m.medium === item.medium && m.small === item.small);
                const rate = masterItem ? (item.type === 'work' ? masterItem.coefficient : masterItem.price) : '';
                const amount = calculateAmount(item, masterItem);
                const createDatalistInput = (level, value, options) => `<input list="${item.id}-${level}" value="${value}" onchange="updateItem(${item.id}, '${level}', this.value)" onblur="handleItemBlur(${item.id})" placeholder="${level === 'large' ? 'å¤§' : level === 'medium' ? 'ä¸­' : 'å°'}åˆ†é¡"><datalist id="${item.id}-${level}">${options.map(o => `<option value="${o}"></option>`).join('')}</datalist>`;
                return `<tr><td><span class="type-badge type-${item.type}">${item.type === 'work' ? 'ä½œæ¥­' : 'è³‡æ'}</span></td><td><div class="category-inputs">${createDatalistInput('large', item.large, largeCats)}${createDatalistInput('medium', item.medium, mediumCats)}${createDatalistInput('small', item.small, smallCats)}</div></td><td><input type="number" min="0" value="${item.quantity}" onchange="updateItem(${item.id}, 'quantity', this.value)"></td><td>${rate.toLocaleString()}</td><td class="amount">Â¥${amount.toLocaleString()}</td><td><input type="text" value="${item.memo}" onchange="updateItem(${item.id}, 'memo', this.value)" placeholder="ãƒ¡ãƒ¢"></td><td><button class="delete-btn" onclick="deleteItem(${item.id})">å‰Šé™¤</button></td></tr>`;
            }).join('');
            calculateTotals();
        }

        function calculateAmount(item, masterItem) {
            const quantity = parseFloat(item.quantity) || 0;
            if (!masterItem) return 0;
            if (item.type === 'work') {
                const company = companies.find(c => c.id === currentCompanyId);
                const laborRate = company ? company.laborRate : 0;
                return Math.round(quantity * masterItem.coefficient * laborRate);
            } else { return quantity * masterItem.price; }
        }
        
        function calculateTotals() {
            let workTotal = 0, materialTotal = 0;
            items.forEach(item => {
                const masterList = item.type === 'work' ? workMaster : materialMaster;
                const masterItem = masterList.find(m => m.large === item.large && m.medium === item.medium && m.small === item.small);
                const amount = calculateAmount(item, masterItem);
                if (item.type === 'work') workTotal += amount; else materialTotal += amount;
            });
            document.getElementById('workTotal').textContent = `Â¥${workTotal.toLocaleString()}`;
            document.getElementById('materialTotal').textContent = `Â¥${materialTotal.toLocaleString()}`;
            document.getElementById('grandTotal').textContent = `Â¥${(workTotal + materialTotal).toLocaleString()}`;
        }
        
        // === Modal Management ===
        const masterModal = document.getElementById('masterEditorModal');
        const saveLoadModal = document.getElementById('saveLoadModal');
        function openMasterEditor() { masterModal.style.display = 'flex'; renderMasterLists(); }
        function closeMasterEditor() { masterModal.style.display = 'none'; }
        function openSaveLoadManager() { saveLoadModal.style.display = 'flex'; renderTree(); }
        function closeSaveLoadManager() { saveLoadModal.style.display = 'none'; }
        
        // === Master Editor Modal ===
        function renderMasterLists() {
            const renderList = (type, elId, list, rateKey) => {
                const tbody = document.getElementById(elId);
                tbody.innerHTML = list.map(item => `<tr data-editing="false" id="master-row-${type}-${item.id}"><td data-field="large">${item.large}</td><td data-field="medium">${item.medium}</td><td data-field="small">${item.small}</td><td data-field="${rateKey}">${item[rateKey]}</td><td><button class="edit-btn" onclick="toggleEditMaster('${type}', ${item.id})">ç·¨é›†</button><button class="delete-btn" onclick="deleteMaster('${type}', ${item.id})">Ã—</button></td></tr>`).join('');
            };
            renderList('work', 'workMasterList', workMaster, 'coefficient');
            renderList('material', 'materialMasterList', materialMaster, 'price');
        }
        function toggleEditMaster(type, id) {
            const row = document.getElementById(`master-row-${type}-${id}`);
            const isEditing = row.dataset.editing === 'true';
            const button = row.querySelector('.edit-btn');
            if (isEditing) {
                const masterList = type === 'work' ? workMaster : materialMaster;
                const item = masterList.find(i => i.id === id);
                row.querySelectorAll('td[data-field]').forEach(cell => {
                    const field = cell.dataset.field;
                    const input = cell.querySelector('input');
                    const value = input.type === 'number' ? parseFloat(input.value) : input.value;
                    item[field] = value;
                    cell.innerHTML = value;
                });
                saveAllData();
                button.textContent = 'ç·¨é›†';
                row.dataset.editing = 'false';
                updateTable();
            } else {
                row.querySelectorAll('td[data-field]').forEach(cell => {
                    const field = cell.dataset.field;
                    const currentValue = cell.textContent;
                    const isNumber = field === 'coefficient' || field === 'price';
                    cell.innerHTML = `<input type="${isNumber ? 'number' : 'text'}" value="${currentValue}" ${isNumber ? 'step=\"0.1\"' : ''}>`;
                });
                button.textContent = 'ä¿å­˜';
                row.dataset.editing = 'true';
            }
        }
        function deleteMaster(type, id) { if (confirm('ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { if (type === 'work') workMaster = workMaster.filter(i => i.id !== id); else materialMaster = materialMaster.filter(i => i.id !== id); saveAllData(); renderMasterLists(); updateTable(); } }

        // === Save/Load Tree Modal ===
        function renderTree() { const treeView = document.getElementById('estimateTreeView'); const buildHtml = (nodes) => `<ul>${nodes.map(node => `<li id="node-${node.id}" class="${node.type} ${node.id === selectedNodeId ? 'selected' : ''}" onclick="selectNode(${node.id})">${node.name}${node.children ? buildHtml(node.children) : ''}</li>`).join('')}</ul>`; treeView.innerHTML = buildHtml(estimateTree); }
        function selectNode(id) { selectedNodeId = id; renderTree(); }
        const findNode = (id, nodes = estimateTree) => { for (const node of nodes) { if (node.id === id) return node; if (node.children) { const found = findNode(id, node.children); if (found) return found; } } return null; };
        const findParent = (childId, nodes = estimateTree) => { for (const node of nodes) { if (node.children?.some(child => child.id === childId)) return node; if (node.children) { const found = findParent(childId, node.children); if (found) return found; } } return null; };
        function getEstimateData() { return { items: JSON.parse(JSON.stringify(items)), projectInfo: { projectName: document.getElementById('projectName').value, customerName: document.getElementById('customerName').value, vehicleInfo: document.getElementById('vehicleInfo').value }, companyId: currentCompanyId }; }
        function setEstimateData(data) { items = data.items || []; document.getElementById('projectName').value = data.projectInfo.projectName || ''; document.getElementById('customerName').value = data.projectInfo.customerName || ''; document.getElementById('vehicleInfo').value = data.projectInfo.vehicleInfo || ''; currentCompanyId = data.companyId || companies[0]?.id || 1; renderUI(); }
        function saveNewEstimate() { const parentNode = findNode(selectedNodeId || 1); if (!parentNode || parentNode.type !== 'folder') return alert('ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); const name = prompt('ä¿å­˜ã™ã‚‹è¦‹ç©ã‚‚ã‚Šå:', document.getElementById('projectName').value); if (name) { parentNode.children.push({ id: Date.now(), name, type: 'file', parentId: parentNode.id, data: getEstimateData() }); saveAllData(); renderTree(); } }
        function overwriteEstimate() { const node = findNode(selectedNodeId); if (!node || node.type !== 'file') return alert('ä¸Šæ›¸ãä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); if (confirm(`ã€Œ${node.name}ã€ã‚’ç¾åœ¨ã®å†…å®¹ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) { node.data = getEstimateData(); saveAllData(); alert('ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸã€‚'); } }
        function loadEstimate() { const node = findNode(selectedNodeId); if (!node || node.type !== 'file') return alert('èª­ã¿è¾¼ã‚€ãƒ•ã‚¡ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); if (confirm(`ã€Œ${node.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) { setEstimateData(node.data); closeSaveLoadManager(); } }
        function createFolder() { const parentNode = findNode(selectedNodeId || 1); if (!parentNode || parentNode.type !== 'folder') return alert('ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); const name = prompt('ä½œæˆã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€å:'); if (name) { parentNode.children.push({ id: Date.now(), name, type: 'folder', parentId: parentNode.id, children: [] }); saveAllData(); renderTree(); } }
        function renameNode() { const node = findNode(selectedNodeId); if (!node || node.id === 1) return alert('åç§°å¤‰æ›´ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); const newName = prompt('æ–°ã—ã„åç§°:', node.name); if (newName) { node.name = newName; saveAllData(); renderTree(); } }
        function deleteNode() { const node = findNode(selectedNodeId); if (!node || node.id === 1) return alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); if (confirm(`ã€Œ${node.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { const parent = findParent(selectedNodeId); if (parent?.children) { parent.children = parent.children.filter(child => child.id !== selectedNodeId); selectedNodeId = parent.id; saveAllData(); renderTree(); } } }
        
        // === Data Migration, Print, CSV ===
        function exportAllData() { const dataStr = JSON.stringify({ companies, currentCompanyId, workMaster, materialMaster, estimateTree }); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'estimate_tool_backup.json'; a.click(); URL.revokeObjectURL(url); }
        function importAllData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { if (confirm('ç¾åœ¨ã®å…¨ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { try { const data = JSON.parse(e.target.result); companies = data.companies || getDefaultCompanies(); currentCompanyId = data.currentCompanyId || 1; workMaster = data.workMaster || getDefaultWorkMaster(); materialMaster = data.materialMaster || getDefaultMaterialMaster(); estimateTree = data.estimateTree || getDefaultTree(); saveAllData(); renderUI(); alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚'); } catch (err) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }}}; reader.readAsText(file); event.target.value = ''; }
        function printEstimate() {
            const company = companies.find(c => c.id === currentCompanyId); if (!company) return alert("ä¼šç¤¾æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            const printWindow = window.open('', '', 'height=800,width=800'); if (!printWindow) return alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            const { projectName, customerName, vehicleInfo } = { projectName: document.getElementById('projectName').value, customerName: document.getElementById('customerName').value, vehicleInfo: document.getElementById('vehicleInfo').value };
            const currentDate = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
            let tableRowsHtml = '';
            items.forEach(item => { const masterList = item.type === 'work' ? workMaster : materialMaster; const masterItem = masterList.find(m => m.large === item.large && m.medium === item.medium && m.small === item.small); const amount = calculateAmount(item, masterItem); const rate = masterItem ? (item.type === 'work' ? masterItem.coefficient : masterItem.price.toLocaleString()) : 'N/A'; tableRowsHtml += `<tr><td style="text-align:center;">${item.type === 'work' ? 'ä½œæ¥­' : 'è³‡æ'}</td><td>${item.large || ''} &gt; ${item.medium || ''} &gt; ${item.small || ''}</td><td style="text-align:center;">${item.quantity}</td><td class="amount">${rate}</td><td class="amount">Â¥${amount.toLocaleString()}</td><td>${item.memo || ''}</td></tr>`; });
            let workTotal = 0, materialTotal = 0;
            items.forEach(item => { const masterList = item.type === 'work' ? workMaster : materialMaster; const masterItem = masterList.find(m => m.large === item.large && m.medium === item.medium && m.small === item.small); const amount = calculateAmount(item, masterItem); if (item.type === 'work') workTotal += amount; else materialTotal += amount; });
            const grandTotal = workTotal + materialTotal;
            const fullHtml = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>å¾¡è¦‹ç©æ›¸ - ${projectName}</title><style>body{font-family:'MS Mincho','Hiragino Mincho ProN',serif;margin:20px;font-size:11pt;color:#000;}.no-print{text-align:right;margin-bottom:15px;}h1{text-align:center;font-size:24pt;margin:0;letter-spacing:5px;}.header-info{display:flex;justify-content:space-between;align-items:flex-start;margin:30px 0;}.customer-info{border-bottom:1px solid black;padding-bottom:5px;font-size:14pt;}.company-info{text-align:right;}p{margin:5px 0;}table{width:100%;border-collapse:collapse;margin-top:10px;}th,td{border:1px solid #000;padding:8px;text-align:left;}th{background-color:#e9e9e9;text-align:center;}.amount{text-align:right;}.totals-container{display:flex;justify-content:flex-end;margin-top:20px;}.totals{border:2px solid black;padding:10px;width:45%;}.totals div{display:flex;justify-content:space-between;padding:5px 0;}.totals .final-total{border-top:1px solid #000;padding-top:8px;font-weight:bold;font-size:14pt;}@media print{.no-print{display:none;}}</style></head><body><div class="no-print"><button onclick="window.print()">å°åˆ·</button> <button onclick="window.close()">é–‰ã˜ã‚‹</button></div><h1>å¾¡ è¦‹ ç© æ›¸</h1><div class="header-info"><div class="customer-info"><u>${customerName} æ§˜</u></div><div class="company-info"><p>ç™ºè¡Œæ—¥: ${currentDate}</p><p><b>${company.name}</b></p><p>åŠ´å‹™å˜ä¾¡: Â¥${company.laborRate.toLocaleString()} /æ™‚é–“</p></div></div><p><b>ä»¶å: ${projectName}</b></p><p><b>è»Šä¸¡: ${vehicleInfo}</b></p><hr><p style="text-align:center;">ä¸‹è¨˜ã®é€šã‚Šå¾¡è¦‹ç©ç”³ã—ä¸Šã’ã¾ã™ã€‚</p><table><thead><tr><th style="width:8%;">ç¨®åˆ¥</th><th>å†…å®¹ (å¤§ &gt; ä¸­ &gt; å°)</th><th style="width:8%;">æ•°é‡</th><th style="width:12%;">å˜ä¾¡/ä¿‚æ•°</th><th style="width:15%;">é‡‘é¡</th><th>ãƒ¡ãƒ¢</th></tr></thead><tbody>${tableRowsHtml}</tbody></table><div class="totals-container"><div class="totals"><div><span>ä½œæ¥­è²» åˆè¨ˆ</span> <span class="amount">Â¥${workTotal.toLocaleString()}</span></div><div><span>ææ–™è²» åˆè¨ˆ</span> <span class="amount">Â¥${materialTotal.toLocaleString()}</span></div><div class="final-total"><span>å¾¡è¦‹ç©åˆè¨ˆ</span> <span class="amount">Â¥${grandTotal.toLocaleString()}</span></div></div></div></body></html>`;
            printWindow.document.write(fullHtml); printWindow.document.close(); printWindow.focus();
        }
        function exportCSV() { try { let csv = '\"FEFF'; csv += "ç¨®åˆ¥,å¤§åˆ†é¡,ä¸­åˆ†é¡,å°åˆ†é¡,æ•°é‡,å˜ä¾¡/ä¿‚æ•°,é‡‘é¡,ãƒ¡ãƒ¢\n"; items.forEach(item => { const masterList = item.type === 'work' ? workMaster : materialMaster; const masterItem = masterList.find(m => m.large === item.large && m.medium === item.medium && m.small === item.small); const amount = calculateAmount(item, masterItem); const typeText = item.type === 'work' ? 'ä½œæ¥­' : 'è³‡æ'; const rate = masterItem ? (item.type === 'work' ? masterItem.coefficient : masterItem.price) : 0; csv += `"${typeText}","${item.large}","${item.medium}","${item.small}","${item.quantity}","${rate}","${amount}","${item.memo || ''}"\n`; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `è¦‹ç©æ›¸_${document.getElementById('projectName').value}.csv`; link.click(); } catch(e) { alert("CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); } }
    </script>
    <script>
        document.getElementById('copyright').innerHTML = `&copy; ${new Date().getFullYear()} UMEBAN. All Rights Reserved.`;
    </script>
</body>
</html>
